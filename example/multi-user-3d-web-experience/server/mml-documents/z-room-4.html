<m-group id="room-content">
  <m-group id="game-room-group"></m-group>
  <m-frame src="wss:///mml-documents/example-fallguys.html" y="200"></m-frame>
</m-group>

<script>
  const gameRoomGroup = document.getElementById("game-room-group");
  const roomContentGroup = document.getElementById("room-content");

  function animate(element, attr, start, end, duration, easing) {
    const anim = document.createElement("m-attr-anim");
    anim.setAttribute("attr", attr);
    anim.setAttribute("start", start);
    anim.setAttribute("end", end);
    anim.setAttribute("start-time", document.timeline.currentTime);
    anim.setAttribute("end-time", document.timeline.currentTime + duration);
    anim.setAttribute("duration", duration);
    anim.setAttribute("easing", easing);
    anim.setAttribute("loop", false);
    element.appendChild(anim);
    setTimeout(() => {
      element.setAttribute(attr, end);
      element.removeChild(anim);
    }, duration);
    return anim;
  }

  function createTeleporter(posX, posY, posZ, targetY) {
    const usersColliding = new Set();

    const teleporterStart = document.createElement("m-model");
    teleporterStart.setAttribute("src", "/assets/playground/teleporter_base.glb");
    teleporterStart.setAttribute("x", posX);
    teleporterStart.setAttribute("y", posY);
    teleporterStart.setAttribute("z", posZ);

    const transporter = document.createElement("m-model");
    transporter.setAttribute("src", "/assets/playground/teleporter_platform_emissive.glb");
    transporter.setAttribute("opacity", 0.0);
    teleporterStart.appendChild(transporter);

    const teleporterEnd = document.createElement("m-model");
    teleporterEnd.setAttribute("src", "/assets/playground/teleporter_base.glb");
    teleporterEnd.setAttribute("x", posX);
    teleporterEnd.setAttribute("y", posY + targetY);
    teleporterEnd.setAttribute("z", posZ + 10);
    teleporterStart.appendChild(teleporterEnd);

    const teleport = () => {
      setTimeout(() => {
        transporter.setAttribute("x", posX);
        transporter.setAttribute("y", targetY);
        transporter.setAttribute("z", posZ + 10);
        setTimeout(() => {
          animate(transporter, "y", targetY, targetY - 0.1, 2100, "EaseInOutCubic");
        }, 300);
        setTimeout(() => {
          transporter.setAttribute("x", 0);
          transporter.setAttribute("y", -0.1);
          transporter.setAttribute("z", 0);
          animate(transporter, "y", -0.1, 0, 2900, "EaseInOutCubic");
        }, 3000);
      }, 3000);
    };

    teleport();
    setInterval(() => {
      teleport();
    }, 6000);

    gameRoomGroup.appendChild(teleporterStart);
  }
  createTeleporter(0, 0, -7, 589.98);

  function createDoor(width, height, x, y, z, thickness, parentElement) {
    const doorGroup = document.createElement("m-group");
    const offset = -0.045;
    const doorAnimDuration = 1200;
    const doorSoundDuration = 1500;
    const buttonAnimDuration = 210;
    const buttonSoundDuration = 1200;
    const easing = "easeInOutCubic";

    let doorIsOpen = false;
    let buttonSoundCanPlay = true;

    const doorFrame = document.createElement("m-model");
    doorFrame.setAttribute("src", "/assets/playground/doorframe.glb");
    doorGroup.appendChild(doorFrame);

    const door = document.createElement("m-cube");
    door.setAttribute("z", 0.035);
    door.setAttribute("y", height / 2);
    door.setAttribute("width", width);
    door.setAttribute("height", height);
    door.setAttribute("depth", 0.1);
    door.setAttribute("color", "#707070");
    doorGroup.appendChild(door);

    const buttonSound = document.createElement("m-audio");

    const doorSound = document.createElement("m-audio");
    doorSound.setAttribute("volume", 0);
    doorSound.setAttribute("src", "/assets/playground/door_swoosh.mp3");
    doorSound.setAttribute("loop", false);
    doorSound.setAttribute("start-time", document.timeline.currentTime - (doorSoundDuration + 100));
    doorSound.setAttribute("pause-time", document.timeline.currentTime - 100);
    door.appendChild(doorSound);

    const createModel = (url, x, y, z, yRotation) => {
      const model = document.createElement("m-model");
      model.setAttribute("src", url);
      model.setAttribute("x", x);
      model.setAttribute("y", y);
      model.setAttribute("z", z);
      if (yRotation) {
        model.setAttribute("ry", yRotation);
      }
      return model;
    };

    const scale = (element, size) => {
      element.setAttribute("sx", size);
      element.setAttribute("sy", size);
      element.setAttribute("sz", size);
    };

    const swap = (elementA, elementB) => {
      scale(elementB, 1.0);
      scale(elementA, 0.001);
    };

    const animateElement = (element, attr, start, end, duration, easing) => {
      const buttonAnim = document.createElement("m-attr-anim");
      buttonAnim.setAttribute("attr", attr);
      buttonAnim.setAttribute("start", start);
      buttonAnim.setAttribute("end", end);
      buttonAnim.setAttribute("start-time", document.timeline.currentTime);
      buttonAnim.setAttribute("end-time", document.timeline.currentTime + duration);
      buttonAnim.setAttribute("duration", duration);
      buttonAnim.setAttribute("easing", easing);
      buttonAnim.setAttribute("loop", false);
      element.appendChild(buttonAnim);
      setTimeout(() => {
        element.setAttribute(attr, end);
        element.removeChild(buttonAnim);
      }, duration);
    };

    const buttonBaseURL = "/assets/playground/open_button_base.glb";
    const buttonOnURL = "/assets/playground/open_button_on.glb";
    const buttonOffURL = "/assets/playground/open_button_off.glb";

    const buttonX = 3.19;
    const buttonY = 1.7;

    const doorButtonBase = createModel(buttonBaseURL, buttonX, buttonY, -0.1);
    const doorButtonOn = createModel(buttonOnURL, buttonX, buttonY, -0.1);
    const doorButtonOff = createModel(buttonOffURL, buttonX, buttonY, -0.1);
    scale(doorButtonOff, 0.001);

    const doorBackButtonBase = createModel(buttonBaseURL, buttonX, buttonY, thickness, 180);
    const doorBackButtonOn = createModel(buttonOnURL, buttonX, buttonY, thickness, 180);
    const doorBackButtonOff = createModel(buttonOffURL, buttonX, buttonY, thickness, 180);
    scale(doorBackButtonOff, 0.001);

    doorGroup.appendChild(doorButtonBase);
    doorGroup.appendChild(doorButtonOn);
    doorGroup.appendChild(doorButtonOff);
    doorGroup.appendChild(doorBackButtonBase);
    doorGroup.appendChild(doorBackButtonOn);
    doorGroup.appendChild(doorBackButtonOff);

    const pushButtonAnim = () => {
      animateElement(doorButtonOn, "z", -0.1, -0.045, buttonAnimDuration, easing);
    };

    const pushBackButtonAnim = () => {
      animateElement(
        doorBackButtonOn,
        "z",
        thickness,
        thickness - 0.045,
        buttonAnimDuration,
        easing,
      );
    };

    const releaseButtonAnim = () => {
      animateElement(doorButtonOn, "z", -0.045, -0.1, buttonAnimDuration, easing);
    };

    const releaseBackButtonAnim = () => {
      animateElement(
        doorBackButtonOn,
        "z",
        thickness - 0.045,
        thickness,
        buttonAnimDuration,
        easing,
      );
    };

    const setupButtonSound = () => {
      buttonSound.setAttribute("y", 1.2);
      buttonSound.setAttribute("loop", false);
      buttonSound.setAttribute("debug", false);
      buttonSound.setAttribute("src", "/assets/playground/button_sfx.mp3");
      buttonSound.setAttribute("volume", 0);
      buttonSound.setAttribute("start-time", document.timeline.currentTime - buttonSoundDuration);
      buttonSound.setAttribute("pause-time", document.timeline.currentTime);
      doorButtonBase.appendChild(buttonSound);
    };

    const playButtonSound = () => {
      if (buttonSoundCanPlay === false) {
        return;
      }
      buttonSoundCanPlay === false;
      const now = document.timeline.currentTime;
      buttonSound.setAttribute("volume", 2);
      buttonSound.setAttribute("start-time", now);
      buttonSound.setAttribute("pause-time", now + buttonSoundDuration);
      setTimeout(() => {
        buttonSound.setAttribute("volume", 0);
        buttonSoundCanPlay === true;
      }, buttonSoundDuration);
    };

    const playDoorSound = () => {
      doorSound.setAttribute("volume", 3);
      doorSound.setAttribute("start-time", document.timeline.currentTime);
      doorSound.setAttribute("pause-time", document.timeline.currentTime + doorSoundDuration);
      setTimeout(() => doorSound.setAttribute("volume", 0), doorSoundDuration);
    };

    const openDoor = () => {
      if (doorIsOpen) return;
      doorIsOpen = true;
      playDoorSound();
      animateElement(door, "y", height / 2, height / 2 + height, doorAnimDuration, easing);
    };

    const closeDoor = () => {
      if (!doorIsOpen) return;
      doorIsOpen = false;
      playDoorSound();
      animateElement(door, "y", height / 2 + height, height / 2, doorAnimDuration, easing);
    };

    doorButtonOn.addEventListener("click", () => {
      pushButtonAnim();
      openDoor();
      setTimeout(() => {
        releaseButtonAnim();
        setTimeout(() => {
          swap(doorButtonOn, doorButtonOff);
          swap(doorBackButtonOn, doorBackButtonOff);
        }, buttonAnimDuration + 20);
        setTimeout(() => {
          closeDoor();
          swap(doorButtonOff, doorButtonOn);
          swap(doorBackButtonOff, doorBackButtonOn);
        }, 5000);
      }, buttonAnimDuration + 20);
      playButtonSound();
    });

    doorBackButtonOn.addEventListener("click", () => {
      pushBackButtonAnim();
      openDoor();
      setTimeout(() => {
        releaseBackButtonAnim();
        setTimeout(() => {
          swap(doorButtonOn, doorButtonOff);
          swap(doorBackButtonOn, doorBackButtonOff);
        }, buttonAnimDuration + 20);
        setTimeout(() => {
          closeDoor();
          swap(doorButtonOff, doorButtonOn);
          swap(doorBackButtonOff, doorBackButtonOn);
        }, 5000);
      }, buttonAnimDuration + 20);
      playButtonSound();
    });

    doorGroup.setAttribute("x", x);
    doorGroup.setAttribute("y", y);
    doorGroup.setAttribute("z", z);
    setupButtonSound();
    parentElement.appendChild(doorGroup);
  }
  createDoor(5, 6, -12.6, 0.03, 22.55, 0.39, roomContentGroup);
</script>
