<m-group id="demo-group">
  <m-group id="game-group" y="1.45"></m-group>
</m-group>

<script>
  const demoGroup = document.getElementById("demo-group");
  const gameGroup = document.getElementById("game-group");

  const columns = 4;
  const animDuration = 550;
  const colorOff = "#424242";
  const colorOn = "#eeeeee";
  const colorMatch = "#ccffcc";
  const defaultEasing = "easeInOutCubic";
  const imgPrefix = "memgame_image_";
  const numberOfAvailableImages = 21;
  const numberOfImages = 8;

  const imageScale = 1.5;
  const cubeScale = 1.6;
  const gap = 1.7;

  const blocks = new Map();

  const availableImages = [
    "https://mmlstorage.com/272a6ca6374b7d4bba5b7b74aedfb3f9fa8a8bc5b5508d08cb689234b6044e86",
    "https://mmlstorage.com/d7a5776fabc1363b1f600beb89b2d86ec4d53d1b7e149fc35170bdb5e8dee741",
    "https://mmlstorage.com/1df2d0723bf9b36686b1f6378c668a96fa92b0dc78c0e2d54fd371e39c1e98bc",
    "https://mmlstorage.com/5007e0b7453a007e1b4078490e8998f8f74d244d5f8fd765dfa8dfdac58dc05c",
    "https://mmlstorage.com/94fb4f7405f73ef9b9fbe52477db7fd29540e6b0056a2cb65aa17c57cb37cc62",
    "https://mmlstorage.com/1da393d4db0c729b7a71f01340b8a8046e852c4e32c0424ccf37c6fdd32c1181",
    "https://mmlstorage.com/eb4a77dca77a744a01d30dbdfc7e000bcb03411730a79725b69cf18fd64aa260",
    "https://mmlstorage.com/109b0d55fe7f74115fa2c36c865499f756a29ab54f4281c782eeec9cf18a5983",
    "https://mmlstorage.com/830b11585d7b21fdc017629759cbebd7e71eb2db46b5fe0269340cfaf2e3ddcf",
    "https://mmlstorage.com/60417c1ea26b070e165c1e1c9226c2ba9c2118905223bebbad5dff6acf227073",
    "https://mmlstorage.com/626fcda3aa9d669b0067e8f059102d65d280c11cc9e8771c218b266a8cd29fd5",
    "https://mmlstorage.com/fb8687ddd576e9c10c7e9daed1eef3f6fafece78987be88416af263c15a89008",
    "https://mmlstorage.com/4d36d51ee4fa4628520f863a1246000a8d5918ad21e509072e3d4f646cce3560",
    "https://mmlstorage.com/bc90e445e3f86ecaff21ca46dbedae7ad65637b6e458078f8d2657c3979a2611",
    "https://mmlstorage.com/f33101d7560fd3b9e823b22a0daad594a7705c8bcf3fc246a24748570de9b7cb",
    "https://mmlstorage.com/28b6e9e6d1fa3a4b23e7a2442a9541d8f9b31df2deb539c801ba45e7dcb05877",
    "https://mmlstorage.com/db4e15efe23f5853fab83602ad81777a8326ba1a47159bb157c98502905aec6d",
    "https://mmlstorage.com/343b283a4bba3f6576da68aeb7f9f054046bc65c200589f6d7d753c94db2b939",
    "https://mmlstorage.com/06be4811b5b55fdeb4da1233674f153dd2112a373ba56accb03d61ab80b9b20f",
    "https://mmlstorage.com/282ea972e3478046e108e6ed106c4b6ecf468b488165b491dcc5849d0c2cc1fc",
    "https://mmlstorage.com/4d56ed1dcd72c7446ca4ecd01d68670f3b9cff65559a591436b1ac82e324e561",
  ];

  let images = [];
  let imagesDuplicated = [];

  let animating = false;
  let firstIndexSelected = null;
  let secondIndexSelected = null;

  let soundPlay = null;
  let soundYes = null;
  let soundNo = null;
  let soundWin = null;

  let gamesPlayed = 0;
  let isReseting = true;
  let isReset = false;
  let gameInProgress = false;
  let lastReset = document.timeline.currentTime;

  // reset detection ================================================
  class ResetDetector {
    playersInRange = new Set();
    probe = document.createElement("m-position-probe");
    lastTimeEmpty = document.timeline.currentTime;
    constructor(x, y, z, range, minsToReset, callbackToReset, parentGroup, debug = false) {
      this.probe.setAttribute("x", x);
      this.probe.setAttribute("y", y);
      this.probe.setAttribute("z", z);
      this.probe.setAttribute("range", range);
      this.probe.setAttribute("interval", 1000);
      this.probe.setAttribute("debug", debug);
      this.probe.addEventListener("positionenter", (event) => {
        const { connectionId } = event.detail;
        if (!this.playersInRange.has(connectionId)) {
          this.playersInRange.add(connectionId);
        }
      });
      this.probe.addEventListener("positionmove", (event) => {
        const { connectionId } = event.detail;
        if (!this.playersInRange.has(connectionId)) {
          this.playersInRange.add(connectionId);
        }
      });
      this.probe.addEventListener("positionleave", (event) => {
        const { connectionId } = event.detail;
        if (this.playersInRange.has(connectionId)) {
          this.playersInRange.delete(connectionId);
        }
        if (this.playersInRange.size === 0) {
          this.lastTimeEmpty = document.timeline.currentTime;
        }
      });
      window.addEventListener("disconnected", (event) => {
        const { connectionId } = event.detail;
        if (this.playersInRange.has(connectionId)) {
          this.playersInRange.delete(connectionId);
        }
        if (this.playersInRange.size === 0) {
          this.lastTimeEmpty = document.timeline.currentTime;
        }
      });
      setInterval(() => {
        if (this.playersInRange.size === 0) {
          const timeToReset = minsToReset * 60 * 1000;
          if (this.lastTimeEmpty + timeToReset < document.timeline.currentTime) {
            callbackToReset();
          }
        }
      }, 1000);
      parentGroup.appendChild(this.probe);
    }
    get playersInProbeRange() {
      return this.playersInRange;
    }
    get hasPlayersInRange() {
      return this.playersInRange.size > 0;
    }
  }
  const resetDetector = new ResetDetector(2, 1, 8, 12, 0.5, resetGame, gameGroup);
  // ================================================================

  // interaction buttons ============================================
  class InteractionButton {
    baseModelURL =
      "https://mmlstorage.com/b78b004cfc7c5ba5c0029e6b97d87f1291ad2106e9c724631669684fee295f8d"; // button_base.glb
    playButtonOnModelURL =
      "https://mmlstorage.com/0e99f1b49eba484ae5a2c447f8ed81bdf893bfb1f2c30160327abf5a69a85b75"; // play_button_on.glb
    playButtonOffModelURL =
      "https://mmlstorage.com/0a25bfe85a537917a32dae1f23c442deebc6f4c0594c099a6c576444e8d520a7"; // play_button_off.glb
    questionButtonOnModelURL =
      "https://mmlstorage.com/23e1853309eed73d9777043643ca6786c08c787f1de942646b58f238c28795b8"; // question_button_on.glb
    questionButtonOffModelURL =
      "https://mmlstorage.com/26180e4f0cf7009c3ed4c82cbde72dadb06424012e09a151951f4a9000ffcd56"; // question_button_off.glb
    buttonSoundURL =
      "https://mmlstorage.com/18cf8bddaf0b8dcd93548433637216e3dd086bd3510f00cf83fffc1508932344"; // button_sfx.mp3

    animDuration = 210;
    buttonSoundDuration = 1200;
    offset = 0.03;
    easing = "easeInOutCubic";

    infoSound = null;
    infoSoundDuration = 0;
    infoSoundCanPlay = true;
    buttonSoundCanPlay = true;

    group = document.createElement("m-group");
    base = document.createElement("m-model");
    buttonOn = document.createElement("m-model");
    buttonOff = document.createElement("m-model");
    buttonSound = document.createElement("m-audio");

    constructor(x, y, z, yRotation, parentGroup) {
      this.base.setAttribute("src", this.baseModelURL);
      this.transform(this.group, x, y, z, yRotation);
      this.group.appendChild(this.base);
      parentGroup.appendChild(this.group);
      this.setupButtonSound();
      return this;
    }

    setupPlay(callBackFunction) {
      this.buttonOn.setAttribute("src", this.playButtonOnModelURL);
      this.buttonOff.setAttribute("src", this.playButtonOffModelURL);
      this.group.appendChild(this.buttonOn);
      this.group.appendChild(this.buttonOff);
      this.scale(this.buttonOff, 0.001);

      this.buttonOn.addEventListener("click", () => {
        this.pushButtonAnim();
        setTimeout(() => {
          this.releaseButtonAnim();
          setTimeout(() => {
            this.turnOff();
            callBackFunction();
          }, this.animDuration + 20);
        }, this.animDuration + 20);

        this.playButtonSound();
      });
    }

    setupInfo(infoSoundURL, infoSoundDuration, infoSoundVolume) {
      this.buttonOn.setAttribute("src", this.questionButtonOnModelURL);
      this.buttonOff.setAttribute("src", this.questionButtonOffModelURL);
      this.group.appendChild(this.buttonOn);
      this.group.appendChild(this.buttonOff);
      this.scale(this.buttonOff, 0.001);

      this.infoSound = document.createElement("m-audio");
      this.infoSound.setAttribute("y", 12);
      this.infoSound.setAttribute("rx", 90);
      this.infoSound.setAttribute("cone-angle", 90);
      this.infoSound.setAttribute("cone-falloff-angle", 120);
      this.infoSound.setAttribute("loop", false);
      this.infoSound.setAttribute("debug", false);
      this.infoSound.setAttribute("src", infoSoundURL);
      this.infoSound.setAttribute("volume", 0);
      this.infoSound.setAttribute("start-time", document.timeline.currentTime - infoSoundDuration);
      this.infoSound.setAttribute("pause-time", document.timeline.currentTime);
      this.group.appendChild(this.infoSound);

      this.buttonOn.addEventListener("click", () => {
        this.pushButtonAnim();
        setTimeout(() => {
          this.releaseButtonAnim();
          setTimeout(() => {
            this.turnOff();
            setTimeout(() => this.turnOn(), infoSoundDuration);
          }, this.animDuration + 20);
        }, this.animDuration + 20);

        this.playButtonSound();
        setTimeout(() => {
          this.playInfoSound(infoSoundDuration, infoSoundVolume);
        }, this.buttonSoundDuration * 0.6667);
      });
    }

    turnOff() {
      this.swap(this.buttonOn, this.buttonOff);
    }

    turnOn() {
      this.swap(this.buttonOff, this.buttonOn);
    }

    pushButtonAnim() {
      this.animateButton(this.buttonOn, "y", 0, -this.offset, this.animDuration, this.easing);
      this.animateButton(this.buttonOn, "z", 0, this.offset, this.animDuration, this.easing);
    }

    releaseButtonAnim() {
      this.animateButton(this.buttonOn, "y", -this.offset, 0, this.animDuration, this.easing);
      this.animateButton(this.buttonOn, "z", this.offset, 0, this.animDuration, this.easing);
    }

    playInfoSound(infoSoundDuration, infoSoundVolume) {
      if (this.infoSoundCanPlay === false || this.infoSound === null) {
        return;
      }
      this.infoSoundCanPlay = false;
      const now = document.timeline.currentTime;
      this.infoSound.setAttribute("volume", infoSoundVolume);
      this.infoSound.setAttribute("start-time", now);
      this.infoSound.setAttribute("pause-time", now + infoSoundDuration);
      setTimeout(() => {
        this.infoSound.setAttribute("volume", 0);
        this.infoSoundCanPlay = true;
      }, infoSoundDuration);
    }

    playButtonSound() {
      if (this.buttonSoundCanPlay === false) {
        return;
      }
      this.buttonSoundCanPlay === false;
      const now = document.timeline.currentTime;
      this.buttonSound.setAttribute("volume", 2);
      this.buttonSound.setAttribute("start-time", now);
      this.buttonSound.setAttribute("pause-time", now + this.buttonSoundDuration);
      setTimeout(() => {
        this.buttonSound.setAttribute("volume", 0);
        this.buttonSoundCanPlay === true;
      }, this.buttonSoundDuration);
    }

    transform(element, x, y, z, ry) {
      element.setAttribute("x", x);
      element.setAttribute("y", y);
      element.setAttribute("z", z);
      element.setAttribute("ry", ry);
    }

    scale(element, size) {
      element.setAttribute("sx", size);
      element.setAttribute("sy", size);
      element.setAttribute("sz", size);
    }

    swap(elementA, elementB) {
      this.scale(elementB, 1.0);
      this.scale(elementA, 0.001);
    }

    setupButtonSound() {
      this.buttonSound.setAttribute("y", 1.2);
      this.buttonSound.setAttribute("loop", false);
      this.buttonSound.setAttribute("debug", false);
      this.buttonSound.setAttribute(
        "src",
        "https://mmlstorage.com/18cf8bddaf0b8dcd93548433637216e3dd086bd3510f00cf83fffc1508932344",
      ); // button_sfx.mp3
      this.buttonSound.setAttribute("volume", 0);
      this.buttonSound.setAttribute("start-time", document.timeline.currentTime - 900);
      this.buttonSound.setAttribute("pause-time", document.timeline.currentTime);
      this.group.appendChild(this.buttonSound);
    }

    animateButton(element, attr, start, end, duration, easing) {
      const buttonAnim = document.createElement("m-attr-anim");
      buttonAnim.setAttribute("attr", attr);
      buttonAnim.setAttribute("start", start);
      buttonAnim.setAttribute("end", end);
      buttonAnim.setAttribute("start-time", document.timeline.currentTime);
      buttonAnim.setAttribute("end-time", document.timeline.currentTime + duration);
      buttonAnim.setAttribute("duration", duration);
      buttonAnim.setAttribute("easing", easing);
      buttonAnim.setAttribute("loop", false);
      element.appendChild(buttonAnim);
      setTimeout(() => {
        element.setAttribute(attr, end);
        element.removeChild(buttonAnim);
      }, duration);
    }
  }

  const infoButton = new InteractionButton(-1.4, 0, 2, 180, demoGroup);
  infoButton.setupInfo(
    "https://mmlstorage.com/05fa1af6a867ab316be795481e3aaaf6e858b80e327c0bb9f67f5db8e6702081",
    22000,
    3,
  ); // memory_game.mp3

  const playButton = new InteractionButton(-0.95, 0, 2, 180, demoGroup);
  playButton.setupPlay(() => {
    if (gameInProgress === false && isReseting === false) {
      playSound(soundPlay, 4);
      reStartGame();
    }
  });
  // ================================================================

  function setupAudioTag(element, url) {
    element.setAttribute("src", url);
    element.setAttribute("loop", false);
    element.setAttribute("volume", 0);
    element.setAttribute("start-time", document.timeline.currentTime - 1500);
    element.setAttribute("pause-time", document.timeline.currentTime);
    element.setAttribute("z", 0.5);
    element.setAttribute("x", (columns * cubeScale) / 2 - cubeScale / 2);
    element.setAttribute("y", 5);
    element.setAttribute("rx", 65);
    element.setAttribute("cone-angle", 90);
    element.setAttribute("cone-falloff-angle", 120);
    element.setAttribute("debug", false);
  }

  function createSFX() {
    soundPlay = document.createElement("m-audio");
    setupAudioTag(
      soundPlay,
      "https://mmlstorage.com/aec020fb9ea522a3b921be24f6bc57c504532d8b8bfc489049e74bd0a70e66f1",
    ); // game_play.mp3
    soundYes = document.createElement("m-audio");
    setupAudioTag(
      soundYes,
      "https://mmlstorage.com/0cfc176efacb60caf36175a493d64005b43aba4b3a942b90f86afb4d4c3ef04d",
    ); // game_yes.mp3
    soundNo = document.createElement("m-audio");
    setupAudioTag(
      soundNo,
      "https://mmlstorage.com/56ba2acc1dd6bfb8fd1bd1a4ae41b70989328b354cc1b2e2f2c6f3e003618a1b",
    ); // game_no.mp3
    soundWin = document.createElement("m-audio");
    setupAudioTag(
      soundWin,
      "https://mmlstorage.com/d488bbcf78c3f32a428c4942d754702effeed1855e1331f77c59da723adff76b",
    ); // game_win.mp3
    gameGroup.appendChild(soundPlay);
    gameGroup.appendChild(soundYes);
    gameGroup.appendChild(soundNo);
    gameGroup.appendChild(soundWin);
  }

  function playSound(sound, volume) {
    sound.setAttribute("volume", volume);
    sound.setAttribute("start-time", document.timeline.currentTime);
    sound.setAttribute("pause-time", document.timeline.currentTime + 1200);
    setTimeout(() => sound.setAttribute("volume", 0), 1200);
  }

  // function prepareImages() {
  //   availableImages = [];
  //   images = [];
  //   imagesDuplicated = [];
  //   for (let i = 0; i < numberOfAvailableImages; i++) {
  //     availableImages.push(`${imgPrefix}${i.toString().padStart(2, "0")}.jpg`);
  //   }
  //   while (images.length < numberOfImages) {
  //     const imageName = getRandomImage(availableImages);
  //     const url = `/assets/playground/${imageName}`;
  //     if (!images.includes(url)) {
  //       images.push(url);
  //     }
  //   }
  //   imagesDuplicated = images.concat(images);
  //   shuffleArray(imagesDuplicated);
  // }

  function prepareImages() {
    images = [];
    imagesDuplicated = [];
    while (images.length < numberOfImages) {
      const imageName = getRandomImage(availableImages);
      const url = `${imageName}`;
      if (!images.includes(url)) {
        images.push(url);
      }
    }
    imagesDuplicated = images.concat(images);
    shuffleArray(imagesDuplicated);
  }

  function getRandomImage(arr) {
    const randomIndex = Math.floor(Math.random() * arr.length);
    return arr[randomIndex];
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function createFrame() {
    const totalBlocks = numberOfImages * 2;
    const rows = Math.ceil(totalBlocks / columns);
    const frameWidth = columns * gap;
    const frameHeight = rows * gap;
    const frameGroup = document.createElement("m-group");
    const backCube = document.createElement("m-cube");
    backCube.setAttribute("color", "black");
    backCube.setAttribute("sx", frameWidth + 0.5);
    backCube.setAttribute("sy", frameHeight + 0.5);
    backCube.setAttribute("sz", 0.5);
    backCube.setAttribute("x", frameWidth / 2 - gap / 2);
    backCube.setAttribute("y", frameHeight / 2 - gap / 2);
    backCube.setAttribute("z", -0.35);
    frameGroup.appendChild(backCube);

    const playCube = document.createElement("m-cube");
    playCube.setAttribute("color", "black");
    playCube.setAttribute("sx", frameWidth + 0.5);
    playCube.setAttribute("sy", 1);
    playCube.setAttribute("sz", 0.5);
    playCube.setAttribute("x", frameWidth / 2 - gap / 2);
    playCube.setAttribute("y", -1.25);
    playCube.setAttribute("z", -0.08);
    playCube.setAttribute("rx", -45);
    frameGroup.appendChild(playCube);

    const frameLabel = document.createElement("m-label");
    frameLabel.setAttribute("content", "PLAY");
    frameLabel.setAttribute("padding", 0);
    frameLabel.setAttribute("alignment", "center");
    frameLabel.setAttribute("color", "hsl(150, 50%, 40%)");
    frameLabel.setAttribute("width", 3);
    frameLabel.setAttribute("height", 0.45);
    frameLabel.setAttribute("font-size", 33);
    frameLabel.setAttribute("font-color", "#ffffff");
    frameLabel.setAttribute("x", frameWidth / 2 - gap / 2);
    frameLabel.setAttribute("y", -1.2);
    frameLabel.setAttribute("z", 0.225);
    frameLabel.setAttribute("rx", -45);

    gameGroup.appendChild(frameGroup);
  }

  function createBlock(index) {
    const blockMeshGroup = document.createElement("m-group");

    const column = index % columns;
    const row = Math.floor(index / columns);
    const cube = document.createElement("m-cube");
    cube.setAttribute("color", colorOff);
    cube.setAttribute("sx", cubeScale);
    cube.setAttribute("sy", cubeScale);
    cube.setAttribute("sz", 0.3334);

    const textureSrc = imagesDuplicated[index];
    const texture = document.createElement("m-image");
    texture.setAttribute("src", textureSrc);
    texture.setAttribute("z", 0.1699);
    texture.setAttribute("sx", imageScale);
    texture.setAttribute("sy", imageScale);
    texture.setAttribute("emissive", 1.5);
    blockMeshGroup.appendChild(texture);

    blockMeshGroup.setAttribute("x", column * gap);
    blockMeshGroup.setAttribute("y", row * gap);
    blockMeshGroup.setAttribute("z", 0.1);
    blockMeshGroup.setAttribute("ry", 180);

    const block = {
      id: index,
      group: blockMeshGroup,
      texture: texture,
      mesh: cube,
      hidden: true,
      src: textureSrc,
      pair: null,
      matched: false,
    };

    block.handleClick = (event) => handleBlockClick(block.id, event);
    cube.addEventListener("click", block.handleClick);
    blockMeshGroup.appendChild(cube);

    return block;
  }

  function shuffleMapValuesInPlace(map) {
    const entries = Array.from(map.entries());
    const values = entries.map((entry) => entry[1]);
    for (let i = values.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [values[i], values[j]] = [values[j], values[i]];
    }
    entries.forEach((entry, index) => {
      const block = values[index];
      const newId = entry[0];
      const oldId = block.id;
      block.mesh.removeEventListener("click", block.handleClick);
      block.id = newId;
      block.matched = false;
      block.hidden = true;
      block.handleClick = (event) => handleBlockClick(newId, event);
      block.mesh.addEventListener("click", block.handleClick);
      map.set(newId, block);
    });
  }

  function repositionAllBlocks() {
    shuffleMapValuesInPlace(blocks);
    blocks.forEach((block, index) => {
      const column = index % columns;
      const row = Math.floor(index / columns);
      block.group.setAttribute("x", column * gap);
      block.group.setAttribute("y", row * gap);
    });
  }

  function createAllBlocks() {
    for (let i = 0; i < imagesDuplicated.length; i++) {
      const block = createBlock(i);
      blocks.set(i, block);
      gameGroup.appendChild(block.group);
    }
  }

  function resetAllBlocks() {
    if (gamesPlayed === 0) {
      createAllBlocks();
      findPairs();
    } else {
      repositionAllBlocks();
      findPairs();
    }
  }

  function findPairs() {
    blocks.forEach((block, index) => {
      blocks.forEach((otherBlock, otherIndex) => {
        if (index !== otherIndex && block.src === otherBlock.src) {
          block.pair = otherIndex;
        }
      });
    });
  }

  function animate(element, attr, start, end, duration, easing) {
    animating = true;
    const anim = document.createElement("m-attr-anim");
    anim.setAttribute("attr", attr);
    anim.setAttribute("start", start);
    anim.setAttribute("end", end);
    anim.setAttribute("start-time", document.timeline.currentTime);
    anim.setAttribute("end-time", document.timeline.currentTime + duration);
    anim.setAttribute("duration", duration);
    anim.setAttribute("easing", easing);
    anim.setAttribute("loop", false);
    element.appendChild(anim);
    setTimeout(() => {
      element.setAttribute(attr, end);
      element.removeChild(anim);
      animating = false;
    }, duration + 50);
  }

  function revealAllBlocks(revealDuration) {
    blocks.forEach((block, index) => {
      animate(block.group, "ry", 180, 0, animDuration, defaultEasing);
      setTimeout(() => {
        animate(block.group, "ry", 0, 180, animDuration, defaultEasing);
      }, revealDuration);
    });
    isReset = true;
  }

  function hideAllBlocks() {
    blocks.forEach((block, index) => {
      animate(block.mesh, "color", colorMatch, colorOff, animDuration, defaultEasing);
      animate(block.group, "ry", 0, 180, animDuration, defaultEasing);
    });
  }

  function revealBlock(index) {
    const blockObject = blocks.get(index);
    if (blockObject.hidden === false) {
      return;
    }

    animate(blockObject.group, "ry", 180, 0, animDuration, defaultEasing);
    animate(blockObject.mesh, "color", colorOff, colorOn, animDuration, defaultEasing);

    setTimeout(() => {
      blockObject.hidden = false;
      blockObject.mesh.setAttribute("color", colorOn);
    }, animDuration);

    if (firstIndexSelected === null) {
      firstIndexSelected = index;
    } else if (secondIndexSelected === null) {
      secondIndexSelected = index;
      const match = checkForMatch();
    }
  }

  function hideBlock(index) {
    const blockObject = blocks.get(index);
    animate(blockObject.group, "ry", 0, 180, animDuration, defaultEasing);
    animate(blockObject.mesh, "color", colorOn, colorOff, animDuration, defaultEasing);
    setTimeout(() => {
      blockObject.hidden = true;
    }, animDuration);
  }

  function hideBlocks(indexA, indexB) {
    const blockObjectA = blocks.get(indexA);
    const blockObjectB = blocks.get(indexB);
    animate(blockObjectA.group, "ry", 0, 180, animDuration, defaultEasing);
    animate(blockObjectA.mesh, "color", colorOn, colorOff, animDuration, defaultEasing);
    animate(blockObjectB.group, "ry", 0, 180, animDuration, defaultEasing);
    animate(blockObjectB.mesh, "color", colorOn, colorOff, animDuration, defaultEasing);
    setTimeout(() => {
      blockObjectA.hidden = true;
      blockObjectB.hidden = true;
      firstIndexSelected = null;
      secondIndexSelected = null;
    }, animDuration);
  }

  function checkIfGameOver() {
    let matchedBlocks = 0;
    blocks.forEach((block) => {
      if (block.matched === true) {
        matchedBlocks++;
      }
    });
    if (matchedBlocks === numberOfImages * 2) {
      isReseting = true;
      gameInProgress = false;
      gamesPlayed++;
      setTimeout(() => playSound(soundWin, 3), 1000);
      setTimeout(() => hideAllBlocks(), 2000);
      setTimeout(() => reStartGame(), 4000);
    }
  }

  function checkForMatch() {
    if (firstIndexSelected === null || secondIndexSelected === null) {
      return false;
    }
    const firstBlockObject = blocks.get(firstIndexSelected);
    const secondBlockObject = blocks.get(secondIndexSelected);
    if (firstBlockObject.pair === secondBlockObject.id) {
      firstBlockObject.matched = true;
      secondBlockObject.matched = true;
      animate(firstBlockObject.mesh, "color", colorOn, colorMatch, animDuration, defaultEasing);
      animate(secondBlockObject.mesh, "color", colorOn, colorMatch, animDuration, defaultEasing);
      firstIndexSelected = null;
      secondIndexSelected = null;
      playSound(soundYes, 4);
      checkIfGameOver();
      return true;
    } else {
      playSound(soundNo, 2);
      setTimeout(() => hideBlocks(firstIndexSelected, secondIndexSelected), 1500);
    }
  }

  function handleBlockClick(index, event) {
    if (isReseting) {
      return;
    }
    if (!resetDetector.playersInProbeRange.has(event.detail.connectionId)) {
      return;
    }
    isReset = false;
    gameInProgress = true;
    const bothIndexSelected = firstIndexSelected !== null && secondIndexSelected !== null;
    if (!animating && !bothIndexSelected) {
      const blockObject = blocks.get(index);
      if (blockObject && !blockObject.matched) {
        revealBlock(index);
      }
    }
  }

  function resetGame() {
    if (isReset === true || isReseting === true) {
      return;
    }
    gamesPlayed++;
    isReseting = true;
    gameInProgress = false;
    lastReset = document.timeline.currentTime;
    setTimeout(() => hideAllBlocks(), 100);
    setTimeout(() => resetAllBlocks(), 1500);
    setTimeout(() => reStartGame(), 2500);
  }

  function reStartGame() {
    if (isReset === false) {
      prepareImages();
      resetAllBlocks();
      setTimeout(() => revealAllBlocks(4000), 1500);
      setTimeout(() => {
        lastReset = document.timeline.currentTime;
        isReseting = false;
      }, 5500);
    } else {
      revealAllBlocks(4000);
      setTimeout(() => {
        lastReset = document.timeline.currentTime;
        isReseting = false;
      }, 5500);
    }
  }

  function formatTime(ms) {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const secondsPart = (seconds % 60).toString().padStart(2, "0");
    const minutesPart = (minutes % 60).toString().padStart(2, "0");
    const hoursPart = hours.toString().padStart(2, "0");

    if (hours > 0) {
      return `${hoursPart}h ${minutesPart}m ${secondsPart}s`;
    } else if (minutes > 0) {
      return `${minutesPart}m ${secondsPart}s`;
    } else {
      return `${secondsPart}s`;
    }
  }

  setInterval(() => {
    if (gameInProgress === true || isReseting === true) {
      if (playButton) playButton.turnOff();
    } else {
      if (playButton) playButton.turnOn();
    }
  }, 1000);

  createFrame();
  createSFX();
  reStartGame();
</script>
