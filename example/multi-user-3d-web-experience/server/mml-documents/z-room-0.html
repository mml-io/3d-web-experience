<m-group id="room-content"></m-group>
<m-frame
  src="wss:///mml-documents/example-gliders.html"
  sz="3.14"
  sy="2.63"
  x="-17.65"
  y="2.05"
  z="-0.02"
></m-frame>

<m-frame src="wss:///mml-documents/example-first-interaction.html"></m-frame>

<script>
  const roomContentGroup = document.getElementById("room-content");
  const spectatorsLabel = document.getElementById("spectators-label");

  function setPosition(element, x, y, z, ry = null) {
    element.setAttribute("x", x);
    element.setAttribute("y", y);
    element.setAttribute("z", z);
    if (ry) {
      element.setAttribute("ry", ry);
    }
  }

  function setScale(element, sx, sy, sz) {
    element.setAttribute("sx", sx);
    element.setAttribute("sy", sy);
    element.setAttribute("sz", sz);
  }

  function animate(element, attr, start, end, duration, easing, startTime) {
    const anim = document.createElement("m-attr-anim");
    anim.setAttribute("attr", attr);
    anim.setAttribute("start", start);
    anim.setAttribute("end", end);
    anim.setAttribute("start-time", startTime);
    anim.setAttribute("end-time", startTime + duration);
    anim.setAttribute("duration", duration);
    anim.setAttribute("easing", easing);
    anim.setAttribute("loop", true);
    anim.setAttribute("ping-pong", true);
    anim.setAttribute("ping-pong-delay", duration / 15);
    element.appendChild(anim);
  }

  function createAvatarStand() {
    const standsXPos = 16;
    const avatarYPos = 0.8;

    const standScale = 0.6;
    const zSpacing = 4;
    const zOffset = 6;

    const standGroup = document.createElement("m-group");

    for (let i = 0; i < 4; i++) {
      const zPos = i * zSpacing - zOffset;
      const standModel = document.createElement("m-model");
      standModel.setAttribute("src", "/assets/playground/avatar_plinth.glb");
      setPosition(standModel, standsXPos, 0, zPos);
      setScale(standModel, standScale, standScale, standScale);
      standGroup.appendChild(standModel);

      const standAvatar = document.createElement("m-model");
      standAvatar.setAttribute("src", "/assets/playground/bot.glb");
      standAvatar.setAttribute("anim", "/assets/playground/anim_idle.glb");
      standAvatar.setAttribute("collide", false);

      const standAvatarGroup = document.createElement("m-group");
      standAvatarGroup.appendChild(standAvatar);

      setPosition(standAvatarGroup, standsXPos, avatarYPos, zPos, -90);

      animate(
        standAvatarGroup,
        "y",
        avatarYPos,
        avatarYPos + 0.1,
        7000,
        "easeInOutQuad",
        document.timeline.currentTime - i * 5000,
      );

      animate(
        standAvatarGroup,
        "rx",
        0,
        3,
        12000,
        "easeInOutQuad",
        document.timeline.currentTime - i * 5000,
      );

      animate(
        standAvatarGroup,
        "rz",
        0,
        5,
        12000,
        "easeInOutQuad",
        document.timeline.currentTime - i * 7000,
      );

      animate(
        standAvatarGroup,
        "ry",
        -90,
        -95,
        12000,
        "easeInOutQuad",
        document.timeline.currentTime - i * 5000,
      );

      standGroup.appendChild(standAvatarGroup);
    }
    return standGroup;
  }

  const avatarStands = createAvatarStand();
  roomContentGroup.appendChild(avatarStands);

  function createDoor(
    { width, height, x, y, z, buttonX, buttonY, buttonZFront, buttonZBack },
    parentElement,
  ) {
    const doorGroup = document.createElement("m-group");

    const doorAnimDuration = 1200;
    const doorSoundDuration = 1500;
    const buttonAnimDuration = 210;
    const buttonSoundDuration = 1200;
    const buttonPushOffset = 0.05;

    const easing = "easeInOutCubic";

    let doorIsOpen = false;
    let buttonSoundCanPlay = true;

    const doorFrame = document.createElement("m-model");
    doorFrame.setAttribute(
      "src",
      "https://mmlstorage.com/fa41737dd901fd0e62b98f1c0debc4c1e5d155384507b0abd380e336aa197710",
    );
    // doorGroup.appendChild(doorFrame);

    const door = document.createElement("m-cube");
    door.setAttribute("z", 0.035);
    door.setAttribute("y", height / 2);
    door.setAttribute("width", width);
    door.setAttribute("height", height);
    door.setAttribute("depth", 0.1);
    door.setAttribute("color", "#707070");
    doorGroup.appendChild(door);

    const buttonSound = document.createElement("m-audio");

    const doorSound = document.createElement("m-audio");
    doorSound.setAttribute("volume", 0);
    doorSound.setAttribute(
      "src",
      "https://mmlstorage.com/f4bf35da3d464496b7cc9a0fbe3b695fd938a1e2248322e9f46c77a11d3fc948",
    );
    doorSound.setAttribute("loop", false);
    doorSound.setAttribute("start-time", document.timeline.currentTime - (doorSoundDuration + 100));
    doorSound.setAttribute("pause-time", document.timeline.currentTime - 100);
    door.appendChild(doorSound);

    const createModel = (url, x, y, z, yRotation) => {
      const model = document.createElement("m-model");
      model.setAttribute("src", url);
      model.setAttribute("x", x);
      model.setAttribute("y", y);
      model.setAttribute("z", z);
      if (yRotation) {
        model.setAttribute("ry", yRotation);
      }
      return model;
    };

    const scale = (element, size) => {
      element.setAttribute("sx", size);
      element.setAttribute("sy", size);
      element.setAttribute("sz", size);
    };

    const swap = (elementA, elementB) => {
      scale(elementB, 1.0);
      scale(elementA, 0.001);
    };

    const animateElement = (element, attr, start, end, duration, easing) => {
      const buttonAnim = document.createElement("m-attr-anim");
      buttonAnim.setAttribute("attr", attr);
      buttonAnim.setAttribute("start", start);
      buttonAnim.setAttribute("end", end);
      buttonAnim.setAttribute("start-time", document.timeline.currentTime);
      buttonAnim.setAttribute("end-time", document.timeline.currentTime + duration);
      buttonAnim.setAttribute("duration", duration);
      buttonAnim.setAttribute("easing", easing);
      buttonAnim.setAttribute("loop", false);
      element.appendChild(buttonAnim);
      setTimeout(() => {
        element.setAttribute(attr, end);
        element.removeChild(buttonAnim);
      }, duration);
    };

    const buttonBaseURL =
      "https://mmlstorage.com/26c684816caf7c5ac67ff924b1bf8b0d1a982cedbc11bda4f9b1c54bee8f1bf1";
    const buttonOnURL =
      "https://mmlstorage.com/e06ed8f36e64a28c0d543aeca9d1bcd440b31cdfc1a93aaf91326bf583b02240";
    const buttonOffURL =
      "https://mmlstorage.com/4b1d2fe8a0f2c6b3e732966e94d5b9366f4a2e9e094d476819e5b66a907a4c90";

    const doorButtonBase = createModel(buttonBaseURL, buttonX, buttonY, buttonZFront);
    const doorButtonOn = createModel(buttonOnURL, buttonX, buttonY, buttonZFront);
    const doorButtonOff = createModel(buttonOffURL, buttonX, buttonY, buttonZFront);
    scale(doorButtonOff, 0.001);

    const doorBackButtonBase = createModel(buttonBaseURL, buttonX, buttonY, buttonZBack, 180);
    const doorBackButtonOn = createModel(buttonOnURL, buttonX, buttonY, buttonZBack, 180);
    const doorBackButtonOff = createModel(buttonOffURL, buttonX, buttonY, buttonZBack, 180);
    scale(doorBackButtonOff, 0.001);

    const buttonGroup = document.createElement("m-group");

    buttonGroup.appendChild(doorButtonBase);
    buttonGroup.appendChild(doorButtonOn);
    buttonGroup.appendChild(doorButtonOff);
    buttonGroup.appendChild(doorBackButtonBase);
    buttonGroup.appendChild(doorBackButtonOn);
    buttonGroup.appendChild(doorBackButtonOff);
    buttonGroup.setAttribute("sx", 2);
    buttonGroup.setAttribute("sy", 2);
    buttonGroup.setAttribute("sz", 2);

    doorGroup.appendChild(buttonGroup);

    const pushButtonAnim = () => {
      animateElement(
        doorButtonOn,
        "z",
        buttonZFront,
        buttonZFront + buttonPushOffset,
        buttonAnimDuration,
        easing,
      );
    };

    const pushBackButtonAnim = () => {
      animateElement(
        doorBackButtonOn,
        "z",
        buttonZBack,
        buttonZBack - buttonPushOffset,
        buttonAnimDuration,
        easing,
      );
    };

    const releaseButtonAnim = () => {
      animateElement(
        doorButtonOn,
        "z",
        buttonZFront + buttonPushOffset,
        buttonZFront,
        buttonAnimDuration,
        easing,
      );
    };

    const releaseBackButtonAnim = () => {
      animateElement(
        doorBackButtonOn,
        "z",
        buttonZBack - buttonPushOffset,
        buttonZBack,
        buttonAnimDuration,
        easing,
      );
    };

    const setupButtonSound = () => {
      buttonSound.setAttribute("y", 1.2);
      buttonSound.setAttribute("loop", false);
      buttonSound.setAttribute("debug", false);
      buttonSound.setAttribute(
        "src",
        "https://mmlstorage.com/18cf8bddaf0b8dcd93548433637216e3dd086bd3510f00cf83fffc1508932344",
      );
      buttonSound.setAttribute("volume", 0);
      buttonSound.setAttribute("start-time", document.timeline.currentTime - buttonSoundDuration);
      buttonSound.setAttribute("pause-time", document.timeline.currentTime);
      doorButtonBase.appendChild(buttonSound);
    };

    const playButtonSound = () => {
      if (buttonSoundCanPlay === false) {
        return;
      }
      buttonSoundCanPlay === false;
      const now = document.timeline.currentTime;
      buttonSound.setAttribute("volume", 2);
      buttonSound.setAttribute("start-time", now);
      buttonSound.setAttribute("pause-time", now + buttonSoundDuration);
      setTimeout(() => {
        buttonSound.setAttribute("volume", 0);
        buttonSoundCanPlay === true;
      }, buttonSoundDuration);
    };

    const playDoorSound = () => {
      doorSound.setAttribute("volume", 3);
      doorSound.setAttribute("start-time", document.timeline.currentTime);
      doorSound.setAttribute("pause-time", document.timeline.currentTime + doorSoundDuration);
      setTimeout(() => doorSound.setAttribute("volume", 0), doorSoundDuration);
    };

    const openDoor = () => {
      if (doorIsOpen) return;
      doorIsOpen = true;
      playDoorSound();
      animateElement(door, "y", height / 2, height / 2 + height, doorAnimDuration, easing);
    };

    const closeDoor = () => {
      if (!doorIsOpen) return;
      doorIsOpen = false;
      playDoorSound();
      animateElement(door, "y", height / 2 + height, height / 2, doorAnimDuration, easing);
    };

    doorButtonOn.addEventListener("click", () => {
      pushButtonAnim();
      openDoor();
      setTimeout(() => {
        releaseButtonAnim();
        setTimeout(() => {
          swap(doorButtonOn, doorButtonOff);
          swap(doorBackButtonOn, doorBackButtonOff);
        }, buttonAnimDuration + 20);
        setTimeout(() => {
          closeDoor();
          swap(doorButtonOff, doorButtonOn);
          swap(doorBackButtonOff, doorBackButtonOn);
        }, 5000);
      }, buttonAnimDuration + 20);
      playButtonSound();
    });

    doorBackButtonOn.addEventListener("click", () => {
      pushBackButtonAnim();
      openDoor();
      setTimeout(() => {
        releaseBackButtonAnim();
        setTimeout(() => {
          swap(doorButtonOn, doorButtonOff);
          swap(doorBackButtonOn, doorBackButtonOff);
        }, buttonAnimDuration + 20);
        setTimeout(() => {
          closeDoor();
          swap(doorButtonOff, doorButtonOn);
          swap(doorBackButtonOff, doorBackButtonOn);
        }, 5000);
      }, buttonAnimDuration + 20);
      playButtonSound();
    });

    doorGroup.setAttribute("x", x);
    doorGroup.setAttribute("y", y);
    doorGroup.setAttribute("z", z);
    setupButtonSound();
    parentElement.appendChild(doorGroup);
  }
  createDoor(
    {
      width: 5,
      height: 6,
      x: -12.6,
      y: 0.03,
      z: 22.76,
      buttonX: 1.72,
      buttonY: 0.7,
      buttonZFront: -0.22,
      buttonZBack: 0.29,
    },
    roomContentGroup,
  );
  createDoor(
    {
      width: 5,
      height: 6,
      x: 12.6,
      y: 0.03,
      z: -22.44,
      buttonX: -1.69,
      buttonY: 0.7,
      buttonZFront: -0.22,
      buttonZBack: 0,
    },
    roomContentGroup,
  );
</script>
