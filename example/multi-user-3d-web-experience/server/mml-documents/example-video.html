<m-group id="megadrive-gaming-station" sx="1.25" sy="1.25" sz="1.25" x="-3">
  <m-group id="video-example-group" ry="180" y="0.025">
    <m-model
      src="https://mmlstorage.com/bec8ff4dc09eff0bcf58813f3afd50f0a585090ab9c63bf240c8bdb78115ef0f"
      x="-2"
      ry="40"
      sx="3"
      sy="3"
      sz="3"
    ></m-model>
    <m-group sx="1.5" sy="1.5" sz="1.5" x="-1.1" y="3.5" z="1.1">
      <m-video
        src="https://mmlstorage.com/4b822cfa5c8351fccf3a0677b66099c25642032cdbdfa38a244fb67c0e7bdd9a"
        id="my-video-player"
        ry="40"
        width="3.6"
        height="2.95"
        emissive="2"
      ></m-video>
    </m-group>
  </m-group>

  <m-group id="attributes-label-group" x="-5.31" y="0" z="-1.75" ry="160">
    <m-group id="control-buttons-group" rx="-55" y="-0.3" z="1"> </m-group>
  </m-group>

  <m-group id="attributes-label-group-b" x="-5.4" y="-0.4" z="-1.5" ry="-20">
    <m-model
      y="0.4"
      src="https://mmlstorage.com/fb78bdc93f7d463e7dde14a56535e92ba85336ee9849903193425504ee51ccc0"
      sx="0.4"
      sy="0.6"
      sz="0.4"
    ></m-model>
  </m-group>
</m-group>

<script>
  const attributesGroup = document.getElementById("attributes-label-group-b");
  const videoExampleGroup = document.getElementById("video-example-group");
  const myVideo = document.getElementById("my-video-player");

  const controlButtonsGroup = document.getElementById("control-buttons-group");

  const currentAttributeLabels = new Map();
  const controlButtons = new Map();

  const labelWidth = 4.3;
  const labelHeight = 0.26;
  const borderWidth = 0.17;
  const labelsYOffset = 0.42;

  const buttonWidth = 0.87;
  const buttonHeight = 0.3;

  let latestAttributes = null;

  let videoIndex = 0;
  // https://mmleditor.com/projects/megadrive-gaming-station-f4EcNf
  const videos = [
    "https://mmlstorage.com/4b822cfa5c8351fccf3a0677b66099c25642032cdbdfa38a244fb67c0e7bdd9a", // sonic_1.mp4
    "https://mmlstorage.com/dd1120be56897c3529cdaf9e33c11ec201c9609fb1f6c51a19e3ddcfea5bd0ea", // sonic_ss.mp4
  ];

  let paused = false;
  let muted = true;
  let startedAt = document.timeline.currentTime;
  let lastPaused = document.timeline.currentTime;

  function arraysAreEqual(arr1, arr2) {
    if (arr1 === arr2) {
      // Check if both arrays are the same instance
      return true;
    }
    if (!Array.isArray(arr1) || !Array.isArray(arr2)) {
      return false;
    }
    if (arr1.length !== arr2.length) {
      return false;
    }
    for (let i = 0; i < arr1.length; i++) {
      if (arr1[i] !== arr2[i]) {
        return false;
      }
    }
    return true;
  }

  class CodeDisplay {
    currentAttributeLabels = new Map();
    totalLines = 0;

    /**
     * Creates an instance of CodeDisplay.
     * @param {Object} config Configuration object for the CodeDisplay.
     * @param {number} config.x The x position of the display panel.
     * @param {number} config.y The y position of the display panel.
     * @param {number} config.z The z position of the display panel.
     * @param {number} config.width The width of the display panel.
     * @param {number} config.height The height of the display panel.
     * @param {number} config.depth The depth of the display panel.
     * @param {string} config.bgColor The background color.
     * @param {string} config.fgColor The foreground color.
     * @param {number} config.textWidth The width of each text line.
     * @param {number} config.textHeight The height of each text line.
     * @param {number} config.fontSize The font size for the text.
     * @param {HTMLElement} config.parentElement The parent element to which the panel will be appended.
     */
    constructor({
      x,
      y,
      z,
      width,
      height,
      depth,
      bgColor,
      fgColor,
      textWidth,
      textHeight,
      fontSize,
      parentElement,
    }) {
      this.panel = document.createElement("m-cube");
      this.x = x;
      this.y = y;
      this.z = z;
      this.width = width;
      this.height = height;
      this.depth = depth;
      this.bgColor = bgColor;
      this.fgColor = fgColor;
      this.textWidth = textWidth;
      this.textHeight = textHeight;
      this.fontSize = fontSize;
      this.parentElement = parentElement;

      this.panel.setAttribute("width", this.width);
      this.panel.setAttribute("height", this.height);
      this.panel.setAttribute("depth", this.depth);
      this.panel.setAttribute("color", this.bgColor);
      this.panel.setAttribute("x", this.x);
      this.panel.setAttribute("y", this.height / 2 + this.y);
      this.panel.setAttribute("z", -this.depth / 2 - 0.01 + this.z);
      this.panel.setAttribute("ry", 180);
      this.parentElement.appendChild(this.panel);
    }

    createLabel(index, str) {
      if (str.includes("/assets/playground/")) {
        str = str.replace("/assets/playground/", "https://mml.io/");
      }
      const y = this.totalLines * this.textHeight - index * this.textHeight;
      const yOffset = ((this.totalLines + 0.5) * this.textHeight) / 2;
      const firstOrLast = index === this.totalLines - 1 || index === 0;
      const text = firstOrLast ? ` ${str}` : `    ${str}`;
      const label = document.createElement("m-label");
      label.setAttribute("font-size", this.fontSize);
      label.setAttribute("color", this.bgColor);
      label.setAttribute("content", text);
      label.setAttribute("padding", 0);
      label.setAttribute("alignment", "left");
      label.setAttribute("font-color", this.fgColor);
      label.setAttribute("width", this.textWidth);
      label.setAttribute("height", this.textHeight);
      label.setAttribute("emissive", 4);
      label.setAttribute("y", y - yOffset);
      label.setAttribute("z", this.depth / 2 + 0.01);
      return label;
    }

    createLabels(attributes) {
      this.totalLines = attributes.length;
      this.currentAttributeLabels.forEach((label) => this.panel.removeChild(label));
      this.currentAttributeLabels.clear();
      for (let i = 0; i < attributes.length; i++) {
        const label = this.createLabel(i, attributes[i]);
        this.currentAttributeLabels.set(i, label);
        this.panel.appendChild(label);
      }
    }

    setPanelTextFromAttributes(element, tagOpen, tagClose) {
      const attributes = [];
      for (const attr of element.getAttributeNames()) {
        let val = element.getAttribute(attr);
        if (val.includes("mmlstorage.com")) {
          val = val.replace(
            "https://mmlstorage.com/4b822cfa5c8351fccf3a0677b66099c25642032cdbdfa38a244fb67c0e7bdd9a",
            "https://mml.io/sonic_1.mp4",
          );
          val = val.replace(
            "https://mmlstorage.com/dd1120be56897c3529cdaf9e33c11ec201c9609fb1f6c51a19e3ddcfea5bd0ea",
            "https://mml.io/sonic_ss.mp4",
          );
        }
        const numberVal = parseFloat(val);
        if (!isNaN(numberVal)) val = numberVal.toFixed(2);
        attributes.push(`${attr}="${val}"`);
      }
      attributes.unshift(tagOpen);
      attributes.push(tagClose);
      if (!arraysAreEqual(latestAttributes, attributes)) {
        latestAttributes = attributes;
        this.createLabels(attributes);
      }
    }
  }
  const codeDisplay = new CodeDisplay({
    x: 0.33,
    y: 1.1,
    z: 0.1,
    width: 3.8,
    height: 3,
    depth: 0.1,
    bgColor: "#000000",
    fgColor: "#00ff41",
    textWidth: 3.3,
    textHeight: 0.22,
    fontSize: 18,
    parentElement: attributesGroup,
  });
  codeDisplay.setPanelTextFromAttributes(myVideo, "<m-video", "></m-video>");

  // interaction buttons ============================================
  class InteractionButton {
    baseModelURL =
      "https://mmlstorage.com/b78b004cfc7c5ba5c0029e6b97d87f1291ad2106e9c724631669684fee295f8d"; // button_base.glb
    playButtonOnModelURL =
      "https://mmlstorage.com/0e99f1b49eba484ae5a2c447f8ed81bdf893bfb1f2c30160327abf5a69a85b75"; // play_button_on.glb
    playButtonOffModelURL =
      "https://mmlstorage.com/0a25bfe85a537917a32dae1f23c442deebc6f4c0594c099a6c576444e8d520a7"; // play_button_off.glb
    questionButtonOnModelURL =
      "https://mmlstorage.com/23e1853309eed73d9777043643ca6786c08c787f1de942646b58f238c28795b8"; // question_button_on.glb
    questionButtonOffModelURL =
      "https://mmlstorage.com/26180e4f0cf7009c3ed4c82cbde72dadb06424012e09a151951f4a9000ffcd56"; // question_button_off.glb
    buttonSoundURL =
      "https://mmlstorage.com/18cf8bddaf0b8dcd93548433637216e3dd086bd3510f00cf83fffc1508932344"; // button_sfx.mp3

    animDuration = 210;
    buttonSoundDuration = 1200;
    offset = 0.03;
    easing = "easeInOutCubic";

    infoSound = null;
    infoSoundDuration = 0;
    infoSoundCanPlay = true;
    buttonSoundCanPlay = true;

    group = document.createElement("m-group");
    base = document.createElement("m-model");
    buttonOn = document.createElement("m-model");
    buttonOff = document.createElement("m-model");
    buttonSound = document.createElement("m-audio");

    constructor(x, y, z, yRotation, parentGroup) {
      this.base.setAttribute("src", this.baseModelURL);
      this.transform(this.group, x, y, z, yRotation);
      this.group.appendChild(this.base);
      parentGroup.appendChild(this.group);
      this.setupButtonSound();
      return this;
    }

    setupPlay(callBackFunction) {
      this.buttonOn.setAttribute("src", this.playButtonOnModelURL);
      this.buttonOff.setAttribute("src", this.playButtonOffModelURL);
      this.group.appendChild(this.buttonOn);
      this.group.appendChild(this.buttonOff);
      this.scale(this.buttonOff, 0.001);

      this.buttonOn.addEventListener("click", () => {
        this.pushButtonAnim();
        setTimeout(() => {
          this.releaseButtonAnim();
          setTimeout(() => {
            this.turnOff();
            callBackFunction();
          }, this.animDuration + 20);
        }, this.animDuration + 20);

        this.playButtonSound();
      });
    }

    setupInfo(infoSoundURL, infoSoundDuration, infoSoundVolume) {
      this.buttonOn.setAttribute("src", this.questionButtonOnModelURL);
      this.buttonOff.setAttribute("src", this.questionButtonOffModelURL);
      this.group.appendChild(this.buttonOn);
      this.group.appendChild(this.buttonOff);
      this.scale(this.buttonOff, 0.001);

      this.infoSound = document.createElement("m-audio");
      this.infoSound.setAttribute("y", 12);
      this.infoSound.setAttribute("rx", 90);
      this.infoSound.setAttribute("cone-angle", 90);
      this.infoSound.setAttribute("cone-falloff-angle", 120);
      this.infoSound.setAttribute("loop", false);
      this.infoSound.setAttribute("debug", false);
      this.infoSound.setAttribute("src", infoSoundURL);
      this.infoSound.setAttribute("volume", 0);
      this.infoSound.setAttribute("start-time", document.timeline.currentTime - infoSoundDuration);
      this.infoSound.setAttribute("pause-time", document.timeline.currentTime);
      this.group.appendChild(this.infoSound);

      this.buttonOn.addEventListener("click", () => {
        this.pushButtonAnim();
        setTimeout(() => {
          this.releaseButtonAnim();
          setTimeout(() => {
            this.turnOff();
            setTimeout(() => this.turnOn(), infoSoundDuration);
          }, this.animDuration + 20);
        }, this.animDuration + 20);

        this.playButtonSound();
        setTimeout(() => {
          this.playInfoSound(infoSoundDuration, infoSoundVolume);
        }, this.buttonSoundDuration * 0.6667);
      });
    }

    turnOff() {
      this.swap(this.buttonOn, this.buttonOff);
    }

    turnOn() {
      this.swap(this.buttonOff, this.buttonOn);
    }

    pushButtonAnim() {
      this.animateButton(this.buttonOn, "y", 0, -this.offset, this.animDuration, this.easing);
      this.animateButton(this.buttonOn, "z", 0, this.offset, this.animDuration, this.easing);
    }

    releaseButtonAnim() {
      this.animateButton(this.buttonOn, "y", -this.offset, 0, this.animDuration, this.easing);
      this.animateButton(this.buttonOn, "z", this.offset, 0, this.animDuration, this.easing);
    }

    playInfoSound(infoSoundDuration, infoSoundVolume) {
      if (this.infoSoundCanPlay === false || this.infoSound === null) {
        return;
      }
      this.infoSoundCanPlay = false;
      const now = document.timeline.currentTime;
      this.infoSound.setAttribute("volume", infoSoundVolume);
      this.infoSound.setAttribute("start-time", now);
      this.infoSound.setAttribute("pause-time", now + infoSoundDuration);
      setTimeout(() => {
        this.infoSound.setAttribute("volume", 0);
        this.infoSoundCanPlay = true;
      }, infoSoundDuration);
    }

    playButtonSound() {
      if (this.buttonSoundCanPlay === false) {
        return;
      }
      this.buttonSoundCanPlay === false;
      const now = document.timeline.currentTime;
      this.buttonSound.setAttribute("volume", 2);
      this.buttonSound.setAttribute("start-time", now);
      this.buttonSound.setAttribute("pause-time", now + this.buttonSoundDuration);
      setTimeout(() => {
        this.buttonSound.setAttribute("volume", 0);
        this.buttonSoundCanPlay === true;
      }, this.buttonSoundDuration);
    }

    transform(element, x, y, z, ry) {
      element.setAttribute("x", x);
      element.setAttribute("y", y);
      element.setAttribute("z", z);
      element.setAttribute("ry", ry);
    }

    scale(element, size) {
      element.setAttribute("sx", size);
      element.setAttribute("sy", size);
      element.setAttribute("sz", size);
    }

    swap(elementA, elementB) {
      this.scale(elementB, 1.0);
      this.scale(elementA, 0.001);
    }

    setupButtonSound() {
      this.buttonSound.setAttribute("y", 1.2);
      this.buttonSound.setAttribute("loop", false);
      this.buttonSound.setAttribute("debug", false);
      this.buttonSound.setAttribute(
        "src",
        "https://mmlstorage.com/18cf8bddaf0b8dcd93548433637216e3dd086bd3510f00cf83fffc1508932344",
      ); // button_sfx.mp3
      this.buttonSound.setAttribute("volume", 0);
      this.buttonSound.setAttribute("start-time", document.timeline.currentTime - 900);
      this.buttonSound.setAttribute("pause-time", document.timeline.currentTime);
      this.group.appendChild(this.buttonSound);
    }

    animateButton(element, attr, start, end, duration, easing) {
      const buttonAnim = document.createElement("m-attr-anim");
      buttonAnim.setAttribute("attr", attr);
      buttonAnim.setAttribute("start", start);
      buttonAnim.setAttribute("end", end);
      buttonAnim.setAttribute("start-time", document.timeline.currentTime);
      buttonAnim.setAttribute("end-time", document.timeline.currentTime + duration);
      buttonAnim.setAttribute("duration", duration);
      buttonAnim.setAttribute("easing", easing);
      buttonAnim.setAttribute("loop", false);
      element.appendChild(buttonAnim);
      setTimeout(() => {
        element.setAttribute(attr, end);
        element.removeChild(buttonAnim);
      }, duration);
    }
  }

  const infoButton = new InteractionButton(2.5, 0, 2.3, 180, videoExampleGroup);
  infoButton.setupInfo(
    "https://mmlstorage.com/d1202953ab0f39d7eb634c625fc657f002c369ffaaa378fbfe9b3e59bd201b67",
    4500,
    3,
  ); // placeholder_info_audio.mp3
  // ================================================================

  function createButton(callback, text, amount, index, color) {
    const xOffset = (index + buttonWidth / 2) * buttonWidth;
    const centerOffset = (amount * buttonWidth) / 2 - 0.05;

    const button = document.createElement("m-label");
    button.setAttribute("padding", 0);
    button.setAttribute("font-size", 20);
    button.setAttribute("width", buttonWidth);
    button.setAttribute("height", buttonHeight);
    button.setAttribute("z", 0.016);
    button.setAttribute("x", xOffset - centerOffset);
    button.setAttribute("alignment", "center");
    button.setAttribute("content", text);
    button.setAttribute("color", color);
    button.addEventListener("click", callback);
    return button;
  }

  function createButtons() {
    controlButtons.set("restart", {
      label: "restart",
      cb: restart,
      button: null,
      color: "#aaaaaa",
    });
    controlButtons.set("next", {
      label: "next",
      cb: next,
      button: null,
      color: "#aaaaaa",
    });
    controlButtons.set("pause", {
      label: "pause",
      cb: togglePause,
      button: null,
      color: "#aaaaaa",
    });
    controlButtons.set("toggle", {
      label: "disable",
      cb: toggleEnabled,
      button: null,
      color: "#aaaaaa",
    });
    controlButtons.set("mute", {
      label: "unmute",
      cb: toggleMute,
      button: null,
      color: "#aaaaaa",
    });
    const totalButtons = controlButtons.size;

    const buttonFrame = document.createElement("m-cube");
    buttonFrame.setAttribute("width", totalButtons * buttonWidth + 0.1);
    buttonFrame.setAttribute("height", 0.4);
    buttonFrame.setAttribute("depth", 0.03);
    buttonFrame.setAttribute("z", -0.15);
    buttonFrame.setAttribute("y", 1.05);
    buttonFrame.setAttribute("color", "#212121");

    let index = 0;
    controlButtons.forEach((props) => {
      const color = getColor(totalButtons, index);
      props.color = color;
      const button = createButton(props.cb, props.label, totalButtons, index, color);
      props.button = button;
      const buttonGroup = document.createElement("m-group");
      buttonGroup.appendChild(button);
      buttonFrame.appendChild(buttonGroup);
      index++;
    });

    controlButtonsGroup.appendChild(buttonFrame);
  }

  function next() {
    if (myVideo.getAttribute("enabled") === "false") {
      toggleEnabled();
    }
    const myElement = controlButtons.get("next");
    highlightElement(myElement);
    videoIndex++;
    if (videoIndex > 1) {
      videoIndex = 0;
    }
    startedAt = document.timeline.currentTime;
    lastPaused = document.timeline.currentTime;
    myVideo.setAttribute("src", videos[videoIndex]);
    myVideo.setAttribute("start-time", startedAt);
    myVideo.removeAttribute("pause-time");
  }

  function restart() {
    let enableCalled = false;
    const myElement = controlButtons.get("restart");
    highlightElement(myElement);
    if (myVideo.getAttribute("enabled") === "false") {
      toggleEnabled();
    } else if (myVideo.getAttribute("pause-time") !== null) {
      resume();
    }
    startedAt = document.timeline.currentTime;
    lastPaused = document.timeline.currentTime;
    myVideo.setAttribute("pause-time", lastPaused);
    myVideo.setAttribute("start-time", startedAt);
    myVideo.removeAttribute("pause-time");
  }

  function toggleEnabled(andResume = true) {
    const myElement = controlButtons.get("toggle");
    const myButton = myElement.button;
    highlightElement(myElement);
    const enabled = myVideo.getAttribute("enabled") !== "false";
    if (enabled && andResume) {
      myButton.setAttribute("content", "enable");
      pause();
    } else if (andResume) {
      myButton.setAttribute("content", "disable");
      resume();
    }
    myVideo.setAttribute("enabled", (!enabled).toString());
  }

  function pause() {
    if (paused) return;
    const myElement = controlButtons.get("pause");
    const myButton = myElement.button;
    highlightElement(myElement);
    myButton.setAttribute("content", "resume");
    paused = true;
    lastPaused = document.timeline.currentTime;
    myVideo.setAttribute("pause-time", document.timeline.currentTime);
  }

  function resume() {
    if (!paused) return;
    const myElement = controlButtons.get("pause");
    const myButton = myElement.button;
    highlightElement(myElement);
    myButton.setAttribute("content", "pause");
    paused = false;
    const timeSincePaused = lastPaused - startedAt;
    startedAt = document.timeline.currentTime - timeSincePaused;
    myVideo.setAttribute("start-time", startedAt);
    myVideo.removeAttribute("pause-time");
  }

  function togglePause() {
    if (myVideo.getAttribute("enabled") === "false") {
      toggleEnabled(false);
    }
    const myElement = controlButtons.get("pause");
    highlightElement(myElement);
    if (paused) {
      resume();
    } else {
      pause();
    }
  }

  function toggleMute() {
    const myElement = controlButtons.get("mute");
    const myButton = myElement.button;
    highlightElement(myElement);
    if (muted) {
      myButton.setAttribute("content", "mute");
      myVideo.setAttribute("volume", 2);
    } else {
      myButton.setAttribute("content", "unmute");
      myVideo.setAttribute("volume", 0);
    }
    muted = !muted;
  }

  function highlightElement(element) {
    const color = element.color;
    const hue = parseInt(color.replace("hsl(", "").split(",")[0]);
    element.button.setAttribute("color", `hsl(${hue}, 90%, 80%)`);
    setTimeout(() => element.button.setAttribute("color", color), 160);
  }

  function getColor(totalButtons, index) {
    const hue = (360 * index) / totalButtons;
    return `hsl(${hue}, 30%, 70%)`;
  }

  createButtons();
  if (muted) {
    myVideo.setAttribute("volume", 0);
  }

  setInterval(() => {
    if (codeDisplay) {
      codeDisplay.setPanelTextFromAttributes(myVideo, "<m-video", "></m-video>");
    }
    const toggleEnabledElement = controlButtons.get("toggle");
    const toggleEnabledButton = toggleEnabledElement.button;
    const enabled = myVideo.getAttribute("enabled") !== "false";
    if (enabled) {
      toggleEnabledButton.setAttribute("content", "disable");
    } else {
      toggleEnabledButton.setAttribute("content", "enable");
    }
  }, 250);
</script>
