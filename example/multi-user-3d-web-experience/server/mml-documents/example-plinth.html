<m-group id="plinth-demo">
  <m-model src="/assets/playground/scifi-car-plinth.glb"></m-model>
  <m-model id="button-left" src="/assets/playground/scifi-car-plinth-left.glb"></m-model>
  <m-model id="button-right" src="/assets/playground/scifi-car-plinth-right.glb"></m-model>
  <m-label
    id="display"
    color="#505050"
    font-color="#ffffff"
    font-color="black"
    padding="0"
    alignment="center"
    content="+1"
    rx="-90"
    rz="-90"
    ry="-45"
    width="0.3"
    height="0.2"
    y="0.17"
    x="-4.55"
    font-size="18"
  ></m-label>
  <m-group id="car-wrapper">
    <m-model id="car" src="/assets/playground/scifi-car.glb" y="0.25">
      <m-attr-anim
        attr="y"
        start="0.25"
        end="0.3"
        duration="13000"
        ping-pong="true"
        ping-pong-delay="1000"
        loop="true"
      ></m-attr-anim>
      <m-attr-anim id="car-anim" attr="ry" start="0" end="360" loop="true"></m-attr-anim>
    </m-model>
  </m-group>

  <m-group id="attributes-label-group" x="-1" y="0" z="-8" ry="-90">
    <m-model
      y="0.4"
      src="/assets/playground/mml_code_frame.glb"
      sx="0.45"
      sy="0.45"
      sz="0.45"
    ></m-model>
  </m-group>
</m-group>

<script>
  const plinthDemo = document.getElementById("plinth-demo");
  const car = document.getElementById("car");
  const carWrapper = document.getElementById("car-wrapper");

  const display = document.getElementById("display");
  const buttonLeft = document.getElementById("button-left");
  const buttonRight = document.getElementById("button-right");

  const carAnim = document.getElementById("car-anim");

  let rotationSpeed = 1;
  const minRotationSpeed = -10;
  const maxRotationSpeed = 10;
  const triggerEffectTime = 700;

  const attributesLabelGroup = document.getElementById("attributes-label-group");

  const unitDuration = 20000;

  let animationStartTime;
  let pauseRatio = undefined;

  // interaction buttons ============================================
  class InteractionButton {
    baseModelURL = "/assets/playground/button_base.glb";
    playButtonOnModelURL = "/assets/playground/play_button_on.glb";
    playButtonOffModelURL = "/assets/playground/play_button_off.glb";
    questionButtonOnModelURL = "/assets/playground/question_button_on.glb";
    questionButtonOffModelURL = "/assets/playground/question_button_off.glb";
    buttonSoundURL = "/assets/playground/button_sfx.mp3";

    animDuration = 210;
    buttonSoundDuration = 1200;
    offset = 0.03;
    easing = "easeInOutCubic";

    infoSound = null;
    infoSoundDuration = 0;
    infoSoundCanPlay = true;
    buttonSoundCanPlay = true;

    group = document.createElement("m-group");
    base = document.createElement("m-model");
    buttonOn = document.createElement("m-model");
    buttonOff = document.createElement("m-model");
    buttonSound = document.createElement("m-audio");

    constructor(x, y, z, yRotation, parentGroup) {
      this.base.setAttribute("src", this.baseModelURL);
      this.transform(this.group, x, y, z, yRotation);
      this.group.appendChild(this.base);
      parentGroup.appendChild(this.group);
      this.setupButtonSound();
      return this;
    }

    setupPlay(callBackFunction) {
      this.buttonOn.setAttribute("src", this.playButtonOnModelURL);
      this.buttonOff.setAttribute("src", this.playButtonOffModelURL);
      this.group.appendChild(this.buttonOn);
      this.group.appendChild(this.buttonOff);
      this.scale(this.buttonOff, 0.001);

      this.buttonOn.addEventListener("click", () => {
        this.pushButtonAnim();
        setTimeout(() => {
          this.releaseButtonAnim();
          setTimeout(() => {
            this.turnOff();
            callBackFunction();
          }, this.animDuration + 20);
        }, this.animDuration + 20);

        this.playButtonSound();
      });
    }

    setupInfo(infoSoundURL, infoSoundDuration, infoSoundVolume) {
      this.buttonOn.setAttribute("src", this.questionButtonOnModelURL);
      this.buttonOff.setAttribute("src", this.questionButtonOffModelURL);
      this.group.appendChild(this.buttonOn);
      this.group.appendChild(this.buttonOff);
      this.scale(this.buttonOff, 0.001);

      this.infoSound = document.createElement("m-audio");
      this.infoSound.setAttribute("y", 12);
      this.infoSound.setAttribute("rx", 90);
      this.infoSound.setAttribute("cone-angle", 90);
      this.infoSound.setAttribute("cone-falloff-angle", 120);
      this.infoSound.setAttribute("loop", false);
      this.infoSound.setAttribute("debug", false);
      this.infoSound.setAttribute("src", infoSoundURL);
      this.infoSound.setAttribute("volume", 0);
      this.infoSound.setAttribute("start-time", document.timeline.currentTime - infoSoundDuration);
      this.infoSound.setAttribute("pause-time", document.timeline.currentTime);
      this.group.appendChild(this.infoSound);

      this.buttonOn.addEventListener("click", () => {
        this.pushButtonAnim();
        setTimeout(() => {
          this.releaseButtonAnim();
          setTimeout(() => {
            this.turnOff();
            setTimeout(() => this.turnOn(), infoSoundDuration);
          }, this.animDuration + 20);
        }, this.animDuration + 20);

        this.playButtonSound();
        setTimeout(() => {
          this.playInfoSound(infoSoundDuration, infoSoundVolume);
        }, this.buttonSoundDuration * 0.6667);
      });
    }

    turnOff() {
      this.swap(this.buttonOn, this.buttonOff);
    }

    turnOn() {
      this.swap(this.buttonOff, this.buttonOn);
    }

    pushButtonAnim() {
      this.animateButton(this.buttonOn, "y", 0, -this.offset, this.animDuration, this.easing);
      this.animateButton(this.buttonOn, "z", 0, this.offset, this.animDuration, this.easing);
    }

    releaseButtonAnim() {
      this.animateButton(this.buttonOn, "y", -this.offset, 0, this.animDuration, this.easing);
      this.animateButton(this.buttonOn, "z", this.offset, 0, this.animDuration, this.easing);
    }

    playInfoSound(infoSoundDuration, infoSoundVolume) {
      if (this.infoSoundCanPlay === false || this.infoSound === null) {
        return;
      }
      this.infoSoundCanPlay = false;
      const now = document.timeline.currentTime;
      this.infoSound.setAttribute("volume", infoSoundVolume);
      this.infoSound.setAttribute("start-time", now);
      this.infoSound.setAttribute("pause-time", now + infoSoundDuration);
      setTimeout(() => {
        this.infoSound.setAttribute("volume", 0);
        this.infoSoundCanPlay = true;
      }, infoSoundDuration);
    }

    playButtonSound() {
      if (this.buttonSoundCanPlay === false) {
        return;
      }
      this.buttonSoundCanPlay === false;
      const now = document.timeline.currentTime;
      this.buttonSound.setAttribute("volume", 2);
      this.buttonSound.setAttribute("start-time", now);
      this.buttonSound.setAttribute("pause-time", now + this.buttonSoundDuration);
      setTimeout(() => {
        this.buttonSound.setAttribute("volume", 0);
        this.buttonSoundCanPlay === true;
      }, this.buttonSoundDuration);
    }

    transform(element, x, y, z, ry) {
      element.setAttribute("x", x);
      element.setAttribute("y", y);
      element.setAttribute("z", z);
      element.setAttribute("ry", ry);
    }

    scale(element, size) {
      element.setAttribute("sx", size);
      element.setAttribute("sy", size);
      element.setAttribute("sz", size);
    }

    swap(elementA, elementB) {
      this.scale(elementB, 1.0);
      this.scale(elementA, 0.001);
    }

    setupButtonSound() {
      this.buttonSound.setAttribute("y", 1.2);
      this.buttonSound.setAttribute("loop", false);
      this.buttonSound.setAttribute("debug", false);
      this.buttonSound.setAttribute("src", "/assets/playground/button_sfx.mp3");
      this.buttonSound.setAttribute("volume", 0);
      this.buttonSound.setAttribute("start-time", document.timeline.currentTime - 900);
      this.buttonSound.setAttribute("pause-time", document.timeline.currentTime);
      this.group.appendChild(this.buttonSound);
    }

    animateButton(element, attr, start, end, duration, easing) {
      const buttonAnim = document.createElement("m-attr-anim");
      buttonAnim.setAttribute("attr", attr);
      buttonAnim.setAttribute("start", start);
      buttonAnim.setAttribute("end", end);
      buttonAnim.setAttribute("start-time", document.timeline.currentTime);
      buttonAnim.setAttribute("end-time", document.timeline.currentTime + duration);
      buttonAnim.setAttribute("duration", duration);
      buttonAnim.setAttribute("easing", easing);
      buttonAnim.setAttribute("loop", false);
      element.appendChild(buttonAnim);
      setTimeout(() => {
        element.setAttribute(attr, end);
        element.removeChild(buttonAnim);
      }, duration);
    }
  }

  const infoButton = new InteractionButton(-1, 0, -5.3, 90, plinthDemo);
  infoButton.setupInfo("/assets/playground/placeholder_info_audio.mp3", 4500, 3);
  // ================================================================

  function adjustCarAnim(delta) {
    const newRotationSpeed = rotationSpeed + delta;

    if (!(newRotationSpeed <= maxRotationSpeed && newRotationSpeed >= minRotationSpeed)) {
      return;
    }

    const currentTime = document.timeline.currentTime;
    let ratioThroughRotation, currentDuration, timeElapsed;
    if (pauseRatio !== undefined) {
      ratioThroughRotation = pauseRatio;
      if (newRotationSpeed < 0) {
        ratioThroughRotation = 1 - ratioThroughRotation;
      }
    } else {
      currentDuration = unitDuration / Math.abs(rotationSpeed);
      timeElapsed = currentTime - animationStartTime;
      ratioThroughRotation = (timeElapsed % currentDuration) / currentDuration;
    }

    display.setAttribute("content", `${newRotationSpeed > 0 ? "+" : ""}${newRotationSpeed}`);
    if (newRotationSpeed === 0) {
      if (rotationSpeed < 0) {
        ratioThroughRotation = 1 - ratioThroughRotation;
      }
      pauseRatio = ratioThroughRotation;
      car.setAttribute("ry", 360 * ratioThroughRotation);
      carAnim.setAttribute("pause-time", document.timeline.currentTime);
    } else {
      pauseRatio = undefined;
      const newDuration = unitDuration / Math.abs(newRotationSpeed);
      const negativeTime = ratioThroughRotation * newDuration;
      const animationTime = currentTime - negativeTime;
      animationStartTime = animationTime;

      if (carAnim.getAttribute("pause-time")) {
        carAnim.removeAttribute("pause-time");
      }
      carAnim.setAttribute("start-time", animationTime);
      carAnim.setAttribute("start", newRotationSpeed < 0 ? 360 : 0);
      carAnim.setAttribute("end", newRotationSpeed < 0 ? 0 : 360);
      carAnim.setAttribute("duration", newDuration);
    }

    rotationSpeed = newRotationSpeed;
    updateAttributesLabel();
  }

  function increaseRotation() {
    const newRotationSpeed = rotationSpeed + 1;
    if (newRotationSpeed <= maxRotationSpeed) {
      adjustCarAnim(1);
    }
  }

  function decreaseRotation() {
    const newRotationSpeed = rotationSpeed - 1;
    if (newRotationSpeed >= minRotationSpeed) {
      adjustCarAnim(-1);
    }
  }

  class CodeDisplay {
    currentAttributeLabels = new Map();
    totalLines = 0;

    /**
     * Creates an instance of CodeDisplay.
     * @param {Object} config Configuration object for the CodeDisplay.
     * @param {number} config.x The x position of the display panel.
     * @param {number} config.y The y position of the display panel.
     * @param {number} config.z The z position of the display panel.
     * @param {number} config.width The width of the display panel.
     * @param {number} config.height The height of the display panel.
     * @param {number} config.depth The depth of the display panel.
     * @param {string} config.bgColor The background color.
     * @param {string} config.fgColor The foreground color.
     * @param {number} config.textWidth The width of each text line.
     * @param {number} config.textHeight The height of each text line.
     * @param {number} config.fontSize The font size for the text.
     * @param {HTMLElement} config.parentElement The parent element to which the panel will be appended.
     */
    constructor({
      x,
      y,
      z,
      width,
      height,
      depth,
      bgColor,
      fgColor,
      textWidth,
      textHeight,
      fontSize,
      parentElement,
    }) {
      this.panel = document.createElement("m-cube");
      this.x = x;
      this.y = y;
      this.z = z;
      this.width = width;
      this.height = height;
      this.depth = depth;
      this.bgColor = bgColor;
      this.fgColor = fgColor;
      this.textWidth = textWidth;
      this.textHeight = textHeight;
      this.fontSize = fontSize;
      this.parentElement = parentElement;

      this.panel.setAttribute("width", this.width);
      this.panel.setAttribute("height", this.height);
      this.panel.setAttribute("depth", this.depth);
      this.panel.setAttribute("color", this.bgColor);
      this.panel.setAttribute("x", this.x);
      this.panel.setAttribute("y", this.height / 2 + this.y);
      this.panel.setAttribute("z", -this.depth / 2 - 0.01 + this.z);
      this.parentElement.appendChild(this.panel);
    }

    createLabel(index, str) {
      if (str.includes("/assets/playground/")) {
        str = str.replace("/assets/playground/", "https://mml.io/");
      }
      const y = this.totalLines * this.textHeight - index * this.textHeight;
      const yOffset = ((this.totalLines + 0.5) * this.textHeight) / 2;
      const firstOrLast = index === this.totalLines - 1 || index === 0;
      const text = firstOrLast ? ` ${str}` : `    ${str}`;
      const label = document.createElement("m-label");
      label.setAttribute("font-size", this.fontSize);
      label.setAttribute("color", this.bgColor);
      label.setAttribute("content", text);
      label.setAttribute("padding", 0);
      label.setAttribute("alignment", "left");
      label.setAttribute("font-color", this.fgColor);
      label.setAttribute("width", this.textWidth);
      label.setAttribute("height", this.textHeight);
      label.setAttribute("emissive", 4);
      label.setAttribute("y", y - yOffset);
      label.setAttribute("z", this.depth / 2 + 0.01);
      return label;
    }

    createLabels(attributes) {
      this.totalLines = attributes.length;
      this.currentAttributeLabels.forEach((label) => this.panel.removeChild(label));
      this.currentAttributeLabels.clear();
      for (let i = 0; i < attributes.length; i++) {
        const label = this.createLabel(i, attributes[i]);
        this.currentAttributeLabels.set(i, label);
        this.panel.appendChild(label);
      }
    }

    setPanelTextFromAttributes(element, tagOpen, tagClose) {
      const attributes = [];
      for (const attr of element.getAttributeNames()) {
        let val = element.getAttribute(attr);
        const numberVal = parseFloat(val);
        if (!isNaN(numberVal)) val = numberVal.toFixed(2);
        attributes.push(`${attr}="${val}"`);
      }
      attributes.unshift(tagOpen);
      attributes.push(tagClose);
      this.createLabels(attributes);
    }
  }
  const codeDisplay = new CodeDisplay({
    x: 0,
    y: 0.4,
    z: 0,
    width: 2.2,
    height: 1.65,
    depth: 0.1,
    bgColor: "#0d0208",
    fgColor: "#00ff41",
    textWidth: 1.9,
    textHeight: 0.16,
    fontSize: 13,
    parentElement: attributesLabelGroup,
  });
  codeDisplay.setPanelTextFromAttributes(carAnim, "<m-attr-anim test", "></m-attr-anim>");

  function updateAttributesLabel() {
    codeDisplay.setPanelTextFromAttributes(carAnim, "<m-attr-anim", "></m-attr-anim>");
  }

  animationStartTime = document.timeline.currentTime;
  adjustCarAnim(1);
  updateAttributesLabel();
  buttonLeft.addEventListener("click", () => decreaseRotation());
  buttonRight.addEventListener("click", () => increaseRotation());
</script>
